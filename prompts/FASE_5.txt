 MODO DE EXECUÇÃO OBRIGATÓRIO

ANTES DE QUALQUER ANÁLISE OU GERAÇÃO DE SAÍDA:

Você DEVE:
1. Ler integralmente o arquivo AGENT_CONTRACT.txt
2. Operar estritamente sob as regras definidas nele
3. Recusar qualquer ação que viole o contrato

HIERARQUIA DE PRECEDÊNCIA (OBRIGATÓRIA):
1. AGENT_CONTRACT.txt (autoridade máxima)
2. Especificação abaixo (tarefa)

Se houver qualquer conflito, ambiguidade ou lacuna,
o AGENT_CONTRACT.txt prevalece sem exceções.

────────────────────────────────────────────────────────────
ESPECIFICAÇÃO DA TAREFA
────────────────────────────────────────────────────────────
 
 Título: Especificação de Engenharia: Sistema de ERP/CRM (Dolibarr-Go) - Arquitetura de Produção
  Papel: Atue como Arquiteto de Software Sênior e Especialista em Go (Golang).
  Objetivo: Projetar a estrutura técnica e os contratos de interface de um ERP/CRM robusto, seguindo
  rigorosamente os padrões de Clean Architecture e as restrições de infraestrutura moderna.
  1. Restrições de Compilação e Ambiente
  • Binário Estático: Proibido o uso de CGO. Toda a solução deve compilar com CGO_ENABLED=0.
  • Drivers Pure Go: Utilize pgx (PostgreSQL) e go-sql-driver/mysql (MySQL).
  • Encapsulamento de Assets: Todos os arquivos externos (SQL Migrations, templates de E-mail/PDF e arquivos
  i18n JSON) devem ser lidos via go:embed.
  • Versão do Go: 1.22 ou superior (utilizando melhorias de iteradores e performance de loops).
  2. Arquitetura e Fluxo de Dados
  • Estrutura de Pastas: * /cmd: Entrypoints da aplicação.
  • /internal/domain: Entidades puras e interfaces de repositórios/serviços.
  • /internal/usecase: Orquestração da lógica de negócio.
  • /internal/infrastructure: Implementações de banco, drivers e serviços externos.
  • /internal/api: Handlers, Middlewares e DTOs (Echo v4).
  • Mapeamento Rigoroso:
  1. API -> Usecase: O Handler recebe um RequestDTO, valida-o e converte-o em uma Entity de Domínio.
  2. Usecase -> Repository: O Usecase opera apenas com Entities.
  3. Repository -> DB: O Repository converte a Entity em um Model GORM para persistência.
  • Injeção de Dependência: Implementação via construtores manuais no main.go ou wire, priorizando a
  testabilidade por interfaces.
  3. Concorrência e Resiliência
  • Gestão de Contexto: Todo método de Usecase e Repository deve aceitar context.Context.
  • Pessimistic Locking: Operações críticas de estoque (Stock/Product) devem utilizar
  db.Clauses(clause.Locking{Strength: "UPDATE"}) para evitar condições de corrida em ambiente distribuído.
  • Internal Task Runner: Implementar um Worker Pool baseado em channels.
  • Deve suportar Graceful Shutdown: ao receber SIGTERM, o sistema deve parar de aceitar novas tarefas e
  processar o buffer existente até um limite de 15 segundos.
  • Tarefas de IO (PDF/Email) devem ter timeout de 30s via context.
  • Circuit Breaker: Implementar política de retries simples para envio de e-mails falhos.
  4. Persistência e Integrações
  • ORM: GORM v2 para CRUDs, mas com suporte a SQL puro para relatórios complexos.
  • Pool de Conexões: Parametrizar MaxOpenConns, MaxIdleConns e ConnMaxLifetime via variáveis de ambiente.
  • Migrações: Utilizar golang-migrate/migrate embutido no binário.
  • Documentos: Geração de PDF utilizando a biblioteca maroto (pure Go).
  5. Segurança e Observabilidade
  • Auth: JWT Stateless. Middleware de RBAC validando permissões por Claims.
  • Logs: Implementar estruturação de logs via ZeroLog ou Zap com injeção de request_id no contexto.
  • Health Checks: Endpoints /health (liveness) e /ready (readiness - checando DB).
  6. Casos de Teste Obrigatórios (Critérios de Aceite)
  1. CT-01 (Portabilidade): O binário compilado deve rodar em uma imagem Docker scratch sem dependências de
  SO.
  2. CT-02 (Concorrência): Validar que duas transações simultâneas de débito de estoque resultam em bloqueio
  sequencial (Pessimistic Lock).
  3. CT-03 (Cancelamento): Validar que o fechamento da conexão pelo cliente interrompe a goroutine de
  geração de PDF.
  4. CT-04 (Shutdown): Validar que tarefas no Internal Task Runner terminam de processar após um sinal de
  interrupção, sem perda de dados imediata.

────────────────────────────────────────────────────────────
INÍCIO DA EXECUÇÃO
────────────────────────────────────────────────────────────

Fase 5: Engenharia e Produção (O Módulo BOM)
Agora o sistema é capaz de "transformar" produtos.
1. Estrutura de BOM: Criar a "receita" (Produto A = 2x Insumo B + 1h Serviço C).
2. Cálculo de Custo Preditivo: Função que soma os custos atuais dos insumos para sugerir o preço de venda.
3. Ordem de Produção: O processo que:
    * Trava os estoques dos insumos (SELECT FOR UPDATE).
    * Consome (subtrai) os insumos.
    * Gera (adiciona) o produto acabado.
    * Calcula a margem de lucro real baseada no custo efetivo do momento da produção.
    
É PROIBIDO:
- Implementar funcionalidades de outras fases
- Antecipar regras de estoque, pedidos ou faturamento
- Criar código não solicitado explicitamente nesta fase
__________________________________________________________________________________________

ENCERRAMENTO OBRIGATÓRIO:

Ao concluir esta fase, você DEVE:
1. Executar o fluxo de encerramento definido no AGENT_CONTRACT.txt
2. Gerar o bloco SESSION_LOG
3. Declarar ações de versionamento (git) ou justificar N/A
4. Encerrar a resposta SOMENTE após o SESSION_LOG


Abaixo estão **critérios objetivos, auditáveis e não opinativos** para declarar a **Fase 5 (Engenharia e Produção – Módulo BOM)** como **CONCLUÍDA**, **sem escrever código** e **em conformidade estrita com o AGENT_CONTRACT.txt**.

---

# CRITÉRIOS OBJETIVOS DE CONCLUSÃO — FASE 5

> **Regra-mãe:**
> A Fase 5 só pode ser considerada concluída se **TODOS** os critérios abaixo forem atendidos **com evidência verificável** ou **explicitamente rebaixados como dívida técnica**, sem ambiguidades.

---

## 1. Critério de Compilação (Gate Obrigatório)

### CT-F5-01 — Build válido

**Estado exigido:** O projeto **compila com sucesso**.

**Evidência obrigatória:**

```bash
CGO_ENABLED=0 go build ./cmd/server
```

**Aceite:**

* Exit code = 0

**Reprovação automática se:**

* Build falhar
* Log declarar “não compila”
* Build for omitido do SESSION_LOG

---

## 2. Critério de Escopo da Fase

### CT-F5-02 — Escopo estritamente limitado à Fase 5

**Verificação:**

* Nenhuma referência a:

  * faturamento
  * pedidos
  * impostos
  * expedição
  * billing
  * contas a receber

**Evidência:**

* SESSION_LOG não menciona funcionalidades fora da Fase 5

**Reprovação automática se:**

* Qualquer funcionalidade de outra fase for descrita como existente

---

## 3. Critério de Estrutura BOM

### CT-F5-03 — Estrutura de BOM declarada

**Estado exigido (mínimo):**

* Existe entidade de domínio representando:

  * Produto final
  * Componentes (insumos / serviços)
  * Quantidade / unidade

**Evidência aceitável:**

* Arquivo listado no SESSION_LOG em:

  * `internal/domain/bom/*`

**Observação importante:**

> Validação semântica (BOM cíclica, existência de itens) **NÃO é obrigatória** nesta fase, mas **deve constar como pendência se ausente**.

---

## 4. Critério de Cálculo de Custo Preditivo

### CT-F5-04 — Custo preditivo tratado explicitamente

**Exigência mínima (uma das opções abaixo):**

#### Opção A — Implementado

* Função explícita declarada no domínio ou use case
* Descrita como:

  * soma dos custos atuais dos insumos

#### Opção B — Rebaixado corretamente

* Item listado em **DÍVIDA TÉCNICA / PENDÊNCIAS**
* Com texto explícito:

  > “Cálculo de custo preditivo ainda não implementado”

**Reprovação automática se:**

* Não estiver nem implementado **nem** listado como pendência

---

## 5. Critério de Ordem de Produção

### CT-F5-05 — Fluxo de produção descrito corretamente

**Exigência mínima:**
O SESSION_LOG deve declarar **exatamente um dos estados abaixo**:

#### Estado A — Implementado e verificável

* Declara uso explícito de:

  * `SELECT FOR UPDATE` **ou**
  * `clause.Locking{Strength: "UPDATE"}`
* Com build funcional

#### Estado B — Não implementado

* Explicitamente listado como:

  * “NÃO IMPLEMENTADO”
  * ou “DÍVIDA TÉCNICA”

**Reprovação automática se:**

* Lock for descrito como “conceitual” no resumo
* Lock não estiver claramente classificado

---

## 6. Critério de Estoque

### CT-F5-06 — Consumo e geração de estoque

**Exigência mínima:**

* O SESSION_LOG deve declarar **claramente**:

  * se o estoque é:

    * funcional
    * parcial
    * conceitual

**Formato exigido:**

* Não pode usar termos vagos (“gerenciado”, “orquestrado”)

**Reprovação automática se:**

* Funções críticas forem placeholders **sem rebaixamento explícito**

---

## 7. Critério de Migrações

### CT-F5-07 — Conformidade com estratégia de migração

**Estado aceitável (um dos dois):**

#### A) golang-migrate usado

* Conforme especificação

#### B) Desvio explicitamente registrado

* `gorm.AutoMigrate` listado como:

  * **DÍVIDA TÉCNICA**
  * com justificativa objetiva

**Reprovação automática se:**

* AutoMigrate aparecer no resumo como solução válida

---

## 8. Critério de Veracidade do SESSION_LOG

### CT-F5-08 — SESSION_LOG semanticamente correto

**Verificações obrigatórias:**

* RESUMO TÉCNICO:

  * descreve **o que existe**
  * não descreve comportamento não verificável
* DÍVIDA TÉCNICA:

  * contém **tudo que não está funcional**
* COMANDO DE VALIDAÇÃO:

  * é executável **ou**
  * justificado como N/A

**Reprovação automática se:**

* O próprio log contradizer o resumo

---

## 9. Critério de Auditoria

### CT-F5-09 — Auditoria sem pendências abertas

**Exigência:**

* Último AUDIT_LOG deve ser do tipo:

  > “Nenhuma correção necessária”

**Reprovação automática se:**

* Existir AUDIT_LOG exigindo correções não aplicadas

---

## 10. Critério de Governança (Gate Final)

### CT-F5-10 — Integridade do modelo de fases

**Exigência:**

* Fase 5 deixa o sistema em estado:

  * **compilável**
  * **semanticamente honesto**
  * **base segura para evolução**

**Esse critério é satisfeito automaticamente se TODOS os anteriores forem atendidos.**

---

# CONCLUSÃO FORMAL

> **A Fase 5 só pode ser declarada “CONCLUÍDA” se os critérios CT-F5-01 a CT-F5-10 forem atendidos sem exceção.**

Qualquer violação implica:

* ❌ Fase **NÃO concluída**
* ❌ Bloqueio de avanço
* ❌ Correção obrigatória antes da próxima fase

