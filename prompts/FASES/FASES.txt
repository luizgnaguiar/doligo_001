Fase 1: Funda√ß√£o e "Hardening" (A Base)
Nesta fase, voc√™ configura o que o prompt chama de "bin√°rio autocontido".
1. Bootstrap de Infra: Criar estrutura de pastas (Clean Arch) e carregar configura√ß√µes via Env/Viper.
2. Conectividade: Setup do pool de conex√µes GORM (pgx/mysql pure Go) com os limites de pool parametrizados.
3. Migra√ß√µes: Implementar o sistema de migra√ß√£o embutido com go:embed.
4. Observabilidade: Configurar Logs estruturados e Middleware de Recovery no Echo v4.

√â PROIBIDO:
- Implementar funcionalidades de outras fases
- Antecipar regras de estoque, pedidos ou faturamento
- Criar c√≥digo n√£o solicitado explicitamente nesta fase

---------------------------------------------------------------------------------------------------------------


FASE 2 ‚Äî Implementa√ß√£o t√©cnica restrita ao dom√≠nio Identity e Auth
Escopo estrito da fase:
Garantir identidade autenticada, autoriza√ß√£o b√°sica e rastreabilidade t√©cnica do usu√°rio autenticado, sem aplicar regras de neg√≥cio de m√≥dulos ainda inexistentes.
Requisitos da Fase 2 (Corrigidos)
1. Dom√≠nio Identity (Obrigat√≥rio)
Criar dom√≠nio Identity com:
Entidade User
Entidade Role
Entidade Permission
Criar interfaces de reposit√≥rio no /internal/domain
Criar models GORM apenas para o dom√≠nio Identity
Criar migra√ß√µes embutidas (go:embed) para essas tabelas
- Nenhuma refer√™ncia a estoque, pedidos ou faturamento √© permitida.
2. Autentica√ß√£o JWT Stateless (Obrigat√≥rio)
Implementar:
Endpoint de login
Gera√ß√£o de JWT contendo:
user_id
roles
permissions
Middleware Echo v4 que:
Valida o token
Injeta user_id e permiss√µes no context.Context
Sem RBAC de dom√≠nio, apenas valida√ß√£o t√©cnica de claims
3. Infraestrutura de Auditoria (Base T√©cnica)
Criar apenas a infraestrutura base, consistindo em:
Interface Auditable (ex: GetCreatedBy(), SetUpdatedBy())
Estrutura de contexto para transportar user_id
N√£o aplicar auditoria a m√≥dulos inexistentes
N√£o criar regras de auditoria de estoque, pedidos ou faturamento
- Qualquer uso funcional da auditoria deve ser tratado em fases futuras.

√â EXPRESSAMENTE PROIBIDO NESTA FASE
Implementar regras de estoque, pedidos ou faturamento
Criar pol√≠ticas de neg√≥cio baseadas em permiss√µes
Aplicar auditoria a dom√≠nios n√£o implementados
Declarar CT-01 a CT-04 como atendidos

---------------------------------------------------------------------------------------------------------------


Fase 3: Cadastro e Estrutura de Itens (Os Dados)
Escopo estrito da fase:
Definir estruturas de dados e fluxos CRUD b√°sicos para entidades fundamentais do sistema, sem qualquer l√≥gica de neg√≥cio derivada ou dependente de estoque, pedidos ou faturamento.
Requisitos da Fase 3
1. Terceiros (ThirdParty)
Criar entidade de dom√≠nio ThirdParty
Diferenciar Fornecedor e Cliente apenas por tipo/flag
Criar:
Interfaces de reposit√≥rio
Usecases CRUD b√°sicos
Handlers HTTP correspondentes
Nenhuma regra fiscal, contratual ou de relacionamento com pedidos
2. Produtos e Servi√ßos
Criar entidade de dom√≠nio Item
Diferenciar:
Item estoc√°vel
Servi√ßo (hora-homem)
Criar:
Interfaces de reposit√≥rio
Usecases CRUD b√°sicos
Handlers HTTP
Nenhuma movimenta√ß√£o, reserva ou valida√ß√£o de estoque
3. Preifica√ß√£o (Estrutural)
Definir apenas campos de dados:
Pre√ßo de custo
Pre√ßo de venda
Custo m√©dio
‚ùå N√£o calcular
‚ùå N√£o atualizar automaticamente
‚ùå N√£o validar margem
‚ùå N√£o relacionar com estoque
Regras Obrigat√≥rias da Fase
Todos os m√©todos de usecase e reposit√≥rio devem aceitar context.Context
Aplicar o fluxo rigoroso:
API ‚Üí Usecase ‚Üí Repository ‚Üí DB
Utilizar auditoria (created_by, updated_by) somente como persist√™ncia passiva, se j√° dispon√≠vel

√â EXPRESSAMENTE PROIBIDO NESTA FASE
Implementar regras de estoque, reservas ou consumo
Calcular custo m√©dio ou margem
Criar l√≥gica de faturamento ou pedidos
Declarar crit√©rios de aceite CT-01 a CT-04 como atendidos

---------------------------------------------------------------------------------------------------------------


Corre√ß√£o da Fase 4: Consist√™ncia de Estoque e Valida√ß√£o de Concorr√™ncia

Objetivo da Execu√ß√£o:
Corrigir pend√™ncias t√©cnicas identificadas na Fase 4, garantindo consist√™ncia de dom√≠nio,
integridade referencial e valida√ß√£o expl√≠cita do mecanismo de bloqueio pessimista,
sem introduzir novas funcionalidades ou antecipar fases futuras.

Escopo estrito da corre√ß√£o:

1. Valida√ß√£o de Integridade Referencial no Usecase de Estoque
   - Adicionar valida√ß√µes expl√≠citas no Usecase respons√°vel por StockMovement para garantir
     a exist√™ncia pr√©via de:
       * ItemID
       * WarehouseID
       * BinID (quando aplic√°vel)
   - As valida√ß√µes devem utilizar exclusivamente interfaces de reposit√≥rio existentes
     (ex: Exists / GetByID), sem acesso direto ao banco de dados.
   - Nenhuma l√≥gica de neg√≥cio adicional deve ser introduzida al√©m da valida√ß√£o de exist√™ncia.

2. Valida√ß√£o do Crit√©rio de Aceite CT-02 (Concorr√™ncia)
   - Implementar um teste automatizado que valide o comportamento de bloqueio pessimista
     (SELECT FOR UPDATE) em opera√ß√µes concorrentes de d√©bito de estoque.
   - O teste deve:
     * Executar duas transa√ß√µes concorrentes sobre o mesmo registro de estoque.
     * Demonstrar que a segunda transa√ß√£o aguarda o t√©rmino da primeira.
     * Operar em n√≠vel de reposit√≥rio ou integra√ß√£o, sem depend√™ncia da camada HTTP.
   - O teste deve ser determin√≠stico e reproduz√≠vel.

Restri√ß√µes expl√≠citas da corre√ß√£o:
- Nenhuma cria√ß√£o de novas entidades de dom√≠nio.
- Nenhuma modifica√ß√£o em contratos p√∫blicos de API al√©m do necess√°rio para valida√ß√£o.
- Nenhuma implementa√ß√£o de l√≥gica de produ√ß√£o, BOM, pedidos ou faturamento.
- Nenhuma introdu√ß√£o de processamento ass√≠ncrono, eventos ou task runners.

Todas as altera√ß√µes devem:
- Respeitar o fluxo API ‚Üí Usecase ‚Üí Repository ‚Üí DB.
- Utilizar context.Context em todos os m√©todos afetados.
- Manter a auditoria apenas como persist√™ncia passiva de dados.
- Resultar em um SESSION_LOG em conformidade estrita com o AGENT_CONTRACT.

---------------------------------------------------------------------------------------------------------------


Fase 5: Engenharia e Produ√ß√£o (M√≥dulo BOM)

Objetivo da Fase:
Implementar a modelagem e a execu√ß√£o s√≠ncrona do processo de produ√ß√£o (BOM),
permitindo a transforma√ß√£o determin√≠stica de insumos em produtos acabados,
com consist√™ncia transacional e rastreabilidade de custos, sem introduzir
processamento ass√≠ncrono ou integra√ß√µes externas.

Escopo estrito da fase:

1. Estrutura de BOM (Bill of Materials)
   - Defini√ß√£o das entidades de dom√≠nio que representam a composi√ß√£o de produtos.
   - Um BOM define, de forma declarativa:
     * Quantidade de insumos estoc√°veis consumidos.
     * Quantidade de servi√ßos (hora-homem) associados.
   - O BOM n√£o executa l√≥gica de estoque por si s√≥; √© apenas uma estrutura de dados.

2. C√°lculo de Custo Preditivo
   - Implementa√ß√£o de uma fun√ß√£o s√≠ncrona e determin√≠stica que:
     * Consulta os custos atuais dos insumos e servi√ßos.
     * Calcula o custo total estimado de produ√ß√£o.
   - O c√°lculo n√£o persiste dados, n√£o altera estoque e n√£o gera efeitos colaterais.
   - O resultado √© utilizado apenas como apoio √† decis√£o.

3. Ordem de Produ√ß√£o (Execu√ß√£o S√≠ncrona)
   - Implementa√ß√£o do fluxo de produ√ß√£o como um caso de uso transacional √∫nico:
     * Trava pessimista dos estoques dos insumos (SELECT FOR UPDATE).
     * Valida√ß√£o de disponibilidade de estoque no momento da transa√ß√£o.
     * Consumo (subtra√ß√£o) dos insumos.
     * Gera√ß√£o (adi√ß√£o) do produto acabado.
     * Registro das movimenta√ß√µes no StockLedger.
     * C√°lculo e persist√™ncia do custo real da produ√ß√£o com base nos valores efetivos.
   - Todo o processo deve ocorrer dentro de uma transa√ß√£o at√¥mica.
   - Em caso de erro, a transa√ß√£o deve ser integralmente revertida.

Restri√ß√µes expl√≠citas da fase:
- Nenhum processamento ass√≠ncrono ou uso de task runners.
- Nenhuma gera√ß√£o de documentos (PDF), eventos ou integra√ß√µes externas.
- Nenhuma l√≥gica de faturamento, pedidos de venda ou entrega.
- Nenhuma antecipa√ß√£o de dashboards, relat√≥rios ou an√°lises agregadas.

Todas as implementa√ß√µes devem:
- Respeitar rigorosamente o fluxo API ‚Üí Usecase ‚Üí Repository ‚Üí DB.
- Utilizar context.Context em todos os m√©todos.
- Utilizar auditoria apenas como persist√™ncia passiva de dados.
- Reutilizar o mecanismo de locking e transa√ß√µes j√° estabelecido na Fase 4.

---------------------------------------------------------------------------------------------------------------


Fase 6: Sa√≠da e Intelig√™ncia (Entrega de Valor)
O software pronto para uso operacional e an√°lise.

1. Task Runner de Relat√≥rios
   - Implementar tarefas ass√≠ncronas no Internal Task Runner para:
     * Gera√ß√£o de PDFs de Faturas via maroto.
     * Gera√ß√£o de PDFs de Explos√£o de BOM via maroto.
   - Todas as tarefas de gera√ß√£o de PDF DEVEM:
     * Ser executadas com context.Context.
     * Respeitar timeout m√°ximo de 30s.
     * Ser canceladas imediatamente caso o contexto seja encerrado (CT-03).

2. Resili√™ncia Transacional e Graceful Shutdown
   - Garantir que opera√ß√µes cr√≠ticas j√° existentes (ex.: Produ√ß√£o de BOM):
     * Sejam executadas dentro de transa√ß√µes expl√≠citas.
     * Sejam corretamente commitadas ou rollbackadas em caso de falha.
   - Garantir que, ao receber SIGTERM:
     * O servidor pare de aceitar novas requisi√ß√µes.
     * O Internal Task Runner finalize as tarefas em execu√ß√£o ou respeite o timeout m√°ximo de 15 segundos (CT-04).
   - √â PROIBIDO introduzir nova l√≥gica de produ√ß√£o ou estoque nesta fase; apenas garantir resili√™ncia do fluxo j√° existente.

3. Dashboard de Margem (Somente Leitura)
   - Implementar endpoint(s) de leitura que exponham:
     * Pre√ßo de Venda.
     * Custo efetivo de insumos.
     * Custo de servi√ßos.
     * Impostos calculados.
     * Margem real (Lucro = Pre√ßo de Venda - Custos Totais).
   - O Dashboard:
     * N√ÉO deve introduzir novas regras de c√°lculo de pre√ßo.
     * Deve reutilizar dados j√° persistidos durante a produ√ß√£o e faturamento.
     * Pode utilizar SQL puro para agrega√ß√µes e relat√≥rios complexos.

√â PROIBIDO:
- Implementar novas regras de neg√≥cio de estoque, produ√ß√£o, faturamento ou precifica√ß√£o.
- Criar l√≥gica que altere dados de produ√ß√£o ou financeiros.
- Antecipar funcionalidades anal√≠ticas avan√ßadas (BI, previs√µes, ML).

Fase 7.1 ‚Äî Estabiliza√ß√£o Arquitetural e Contratos de Integra√ß√£o (Sem Wiring)

Objetivo da Fase:
Estabilizar e formalizar os contratos t√©cnicos (interfaces, assinaturas e responsabilidades)
dos m√≥dulos iniciados nas fases anteriores, garantindo que todos os componentes
compilam isoladamente e respeitam rigorosamente a Clean Architecture,
sem qualquer registro em rotas, main.go ou inicializa√ß√£o de infraestrutura.

Esta fase existe explicitamente para impedir estados intermedi√°rios inv√°lidos
e loops de compila√ß√£o.

Escopo estrito da fase:

1. Estabiliza√ß√£o de Usecases (Obrigat√≥rio)
   - Revisar e ajustar os usecases iniciados (ex.: BOM, Margin) para que:
     * Exponham APENAS m√©todos p√∫blicos necess√°rios.
     * Utilizem exclusivamente context.Context como entrada.
     * N√£o dependam de echo.Context, HTTP, valida√ß√£o ou DTOs de API.
     * Compilem isoladamente via `go test ./internal/usecase/...`.

   - √â OBRIGAT√ìRIO que cada usecase:
     * Tenha depend√™ncias expl√≠citas injetadas por interface.
     * N√£o possua imports n√£o utilizados.
     * N√£o contenha l√≥gica de infraestrutura, logging HTTP ou controle de transa√ß√£o fora do contrato.

2. Defini√ß√£o de Contratos P√∫blicos (Obrigat√≥rio)
   - Para cada m√≥dulo estabilizado, definir explicitamente:
     * Interface p√∫blica do Usecase (ex.: BomUsecase, MarginUsecase).
     * Assinaturas completas dos m√©todos (inputs/outputs/erros).
     * Responsabilidade funcional de cada m√©todo.

   - O nome do tipo exportado DEVE ser exatamente o esperado pelos handlers,
     evitando diverg√™ncia sem√¢ntica entre camadas.

3. Consolida√ß√£o de Reposit√≥rios (Obrigat√≥rio)
   - Garantir que todos os reposit√≥rios utilizados pelos usecases:
     * Existam como interfaces no dom√≠nio.
     * Possuam implementa√ß√µes coerentes na infraestrutura.
     * N√£o assumam modelos ou tabelas inexistentes.

   - Qualquer depend√™ncia n√£o implementada DEVE ser rebaixada explicitamente
     para "D√çVIDA T√âCNICA".

4. Proibi√ß√£o Absoluta de Wiring (Regra Cr√≠tica)
   - √â TERMINANTEMENTE PROIBIDO nesta fase:
     * Registrar handlers no Echo.
     * Adicionar rotas.
     * Instanciar usecases no main.go.
     * Inicializar reposit√≥rios no main.go.
     * Modificar o fluxo de startup ou shutdown da aplica√ß√£o.

   - Arquivos podem existir, mas DEVEM permanecer isolados e n√£o referenciados
     pelo entrypoint da aplica√ß√£o.

5. Crit√©rio de Aceite T√©cnico (Obrigat√≥rio)
   - O projeto DEVE:
     * Compilar com `CGO_ENABLED=0 GOOS=linux go build ./cmd/main.go`.
     * Executar `go test ./internal/usecase/...` sem falhas.
     * N√£o apresentar erros de import n√£o utilizado.

6. Session Log (Obrigat√≥rio)
   - O SESSION_LOG desta fase DEVE:
     * Listar apenas arquivos efetivamente modificados.
     * Descrever ajustes de contratos, n√£o "implementa√ß√µes funcionais".
     * Rebaixar qualquer funcionalidade n√£o finalizada para D√çVIDA T√âCNICA.
     * N√ÉO declarar nenhum m√≥dulo como "ativo", "exposto" ou "integrado".

---------------------------------------------------------------------------------------------------------------

FASE 7.2 ‚Äî Wiring Controlado de Usecases no main.go
OBJETIVO
Reintegrar exclusivamente os usecases estabilizados na Fase 7.1 ao cmd/main.go, corrigindo erros de compila√ß√£o relacionados a assinaturas, construtores e interfaces, sem alterar l√≥gica de neg√≥cio, sem modificar handlers e sem introduzir novas rotas HTTP.
O foco desta fase √© restabelecer a compila√ß√£o completa do bin√°rio com CGO_ENABLED=0, mantendo a ader√™ncia estrita √† Clean Architecture.
ESCOPO PERMITIDO
√â PERMITIDO nesta fase:
Modificar apenas o arquivo:
cmd/main.go
Ajustar:
Chamadas de construtores de usecases (New*Usecase)
Tipos de vari√°veis para uso de interfaces p√∫blicas
Ordem de inicializa√ß√£o, se necess√°rio, sem alterar depend√™ncias
Imports para refletir as assinaturas reais dos usecases
Resolver erros de compila√ß√£o relacionados a:
too many arguments in call to New*Usecase
undefined: New*Usecase
incompatibilidade entre tipos concretos e interfaces
ESCOPO PROIBIDO (REGRA CR√çTICA)
√â TERMINANTEMENTE PROIBIDO nesta fase:
Modificar qualquer arquivo fora de cmd/main.go
Alterar handlers (internal/api/handlers/*)
Alterar usecases (internal/usecase/*)
Criar ou modificar DTOs
Registrar novas rotas
Alterar middlewares
Introduzir l√≥gica de neg√≥cio
Ajustar infraestrutura (db, repository, worker, pdf, etc.)
Qualquer necessidade fora do main.go deve ser registrada como D√çVIDA T√âCNICA, nunca implementada.
DIRETRIZES T√âCNICAS OBRIGAT√ìRIAS
O main.go deve:
Instanciar usecases apenas via interfaces p√∫blicas
N√£o depender de implementa√ß√µes concretas internas
N√£o conter l√≥gica de neg√≥cio
Os construtores dos usecases devem ser usados exatamente como definidos na Fase 7.1.
N√£o adaptar assinaturas
N√£o criar wrappers
O build deve respeitar:
CGO_ENABLED=0
GOOS=linux
CRIT√âRIO DE ACEITE T√âCNICO (OBRIGAT√ìRIO)
A fase S√ì √© considerada conclu√≠da se TODOS os comandos abaixo forem verdadeiros:
O projeto compila com sucesso:
CGO_ENABLED=0 GOOS=linux go build ./cmd/main.go
Nenhum arquivo fora de cmd/main.go foi modificado.
Nenhum handler foi alterado direta ou indiretamente.
Nenhuma nova rota foi registrada.
FORMATO DO SESSION LOG (OBRIGAT√ìRIO)
O log final DEVE seguir exatamente o formato abaixo:
### SESSION_LOG_START | Vers√£o: v1.0.0 | Data: YYYY-MM-DD
- ARQUIVOS CRIADOS/MODIFICADOS:
  - cmd/main.go

- RESUMO T√âCNICO:
  - Ajuste do wiring dos usecases de BOM e Margin no main.go.
  - Corre√ß√£o das chamadas de construtores para refletir as interfaces estabilizadas na Fase 7.1.
  - Nenhuma modifica√ß√£o foi realizada em handlers, usecases ou infraestrutura.

- D√çVIDA T√âCNICA / PEND√äNCIAS:
  - [listar apenas se estritamente necess√°rio]

- COMANDO DE VALIDA√á√ÉO:
  - CGO_ENABLED=0 GOOS=linux go build ./cmd/main.go
### SESSION_LOG_END
CONDI√á√ÉO DE FALHA AUTOM√ÅTICA
A fase deve ser considerada FALHA se ocorrer qualquer um dos seguintes:
Build falhar
Qualquer arquivo al√©m de cmd/main.go for alterado
Handler ou rota for modificado
C√≥digo de neg√≥cio for introduzido no main.go
O SESSION LOG divergir do formato exigido


---------------------------------------------------------------------------------------------------------------

FASE 7.2-R ‚Äî Recovery / Rebaseline Controlado do Reposit√≥rio
OBJETIVO
Estabelecer formalmente um novo baseline t√©cnico para o projeto, reconhecendo o estado atual do reposit√≥rio como ponto de partida v√°lido, ap√≥s refatora√ß√µes estruturais realizadas fora do controle estrito das Fases 7.1 e 7.2.
Esta fase N√ÉO introduz mudan√ßas funcionais, N√ÉO altera c√≥digo, e N√ÉO corrige bugs.
Seu √∫nico prop√≥sito √© restaurar a governan√ßa do projeto, permitindo a continuidade das fases subsequentes sem viola√ß√£o contratual recorrente.
ESCOPO PERMITIDO
√â PERMITIDO nesta fase:
N√£o modificar nenhum arquivo do reposit√≥rio
Auditar e declarar explicitamente:
O estado atual dos arquivos
As diverg√™ncias hist√≥ricas em rela√ß√£o √†s Fases 7.1 e 7.2
Registrar no SESSION LOG:
Que o estado atual passa a ser considerado baseline oficial
Que fases futuras devem partir exatamente deste estado
ESCOPO PROIBIDO (REGRA ABSOLUTA)
√â TERMINANTEMENTE PROIBIDO nesta fase:
Criar, editar ou remover qualquer arquivo
Reformatar c√≥digo
Ajustar imports
Corrigir erros
Refatorar nomes
Executar comandos de build como parte da valida√ß√£o
Introduzir l√≥gica de neg√≥cio
Ajustar infraestrutura, handlers, usecases ou dom√≠nio
Qualquer tentativa de modifica√ß√£o invalida automaticamente a fase.
DIRETRIZES DE REBASELINE (OBRIGAT√ìRIAS)
O reposit√≥rio, no estado em que se encontra ao iniciar esta fase, passa a ser considerado:
O baseline oficial do projeto a partir da Fase 7.2-R
Nenhuma inconsist√™ncia hist√≥rica anterior:
Pode ser atribu√≠da a fases futuras
Pode ser usada para invalidar fases posteriores
Todas as fases subsequentes:
Devem assumir este estado como fonte da verdade
Devem respeitar integralmente os contratos definidos a partir daqui
CRIT√âRIO DE ACEITE T√âCNICO (OBRIGAT√ìRIO)
A fase S√ì √© considerada CONCLU√çDA se TODAS as condi√ß√µes abaixo forem verdadeiras:
Nenhum arquivo foi modificado durante a execu√ß√£o da fase
O SESSION LOG declara explicitamente:
A aceita√ß√£o do estado atual como baseline
Nenhuma tentativa de corre√ß√£o t√©cnica foi realizada
FORMATO DO SESSION LOG (OBRIGAT√ìRIO)
O log final DEVE seguir exatamente o formato abaixo:
### SESSION_LOG_START | Vers√£o: v1.0.0 | Data: YYYY-MM-DD
- ARQUIVOS CRIADOS/MODIFICADOS:
  - Nenhum

- RESUMO T√âCNICO:
  - Reconhecimento formal do estado atual do reposit√≥rio como baseline oficial do projeto.
  - Registro de que refatora√ß√µes e altera√ß√µes fora do escopo das Fases 7.1 e 7.2 passam a ser consideradas parte do estado consolidado.
  - Nenhuma modifica√ß√£o de c√≥digo foi realizada nesta fase.

- D√çVIDA T√âCNICA / PEND√äNCIAS:
  - D√©bitos t√©cnicos existentes permanecem registrados conforme logs anteriores, sem altera√ß√£o ou corre√ß√£o nesta fase.

- COMANDO DE VALIDA√á√ÉO:
  - Nenhum (fase declarat√≥ria de rebaseline)
### SESSION_LOG_END
CONDI√á√ÉO DE FALHA AUTOM√ÅTICA
A Fase 7.2-R deve ser considerada FALHA se:
Qualquer arquivo for modificado
Qualquer corre√ß√£o t√©cnica for aplicada
O SESSION LOG omitir a declara√ß√£o expl√≠cita de rebaseline
O formato do log divergir do padr√£o exigido
RESULTADO ESPERADO
Ao final da Fase 7.2-R:
O projeto possui novamente governan√ßa clara
O estado atual do reposit√≥rio √© a nova fonte da verdade
Fases futuras podem ser executadas sem conflitos contratuais
O looping de invalida√ß√£o por contexto hist√≥rico √© eliminado

---------------------------------------------------------------------------------------------------------------

FASE 8 ‚Äî BLOQUEADORES ABSOLUTOS (GATE 0)

Sem 100% de atendimento, produ√ß√£o √© proibida.

FASE 8.1 ‚Äî CT-01: Portabilidade e Bin√°rio Est√°tico
Escopo √∫nico
Build com CGO_ENABLED=0
Execu√ß√£o em Docker scratch
Endpoint /health
Evid√™ncias obrigat√≥rias
Comando de build reproduz√≠vel
Dockerfile scratch
Log ou execu√ß√£o real comprovada
Gate atendido
GATE 0.1 ‚Äî Portabilidade e Runtime

FASE 8.2 ‚Äî Dom√≠nio Invoice / Faturamento
Escopo √∫nico
Dom√≠nio expl√≠cito de Invoice / Faturamento
Models de dom√≠nio
Persist√™ncia (models, reposit√≥rios)
Migra√ß√µes
Remo√ß√£o total de suposi√ß√µes no Margin
Margin passa a depender exclusivamente de dados reais
Proibido
PDFs
Workers
Cancelamento
Shutdown
Gate atendido
GATE 0.2 ‚Äî Integridade de Faturamento

FASE 8.3 ‚Äî PDFs Operacionais (Implementa√ß√£o Real)
Escopo √∫nico
Implementa√ß√£o real de:
InvoicePDFTask
BomPDFTask
Uso de dados reais
Uso obrigat√≥rio de context.Context
Timeout funcional de 30s
Proibido
Placeholders
Cancelamento expl√≠cito
Shutdown
Gate atendido
GATE 0.3 ‚Äî PDFs Operacionais

FASE 8.4 ‚Äî CT-03: Cancelamento
Escopo √∫nico
Provar que:
Cancelamento do request HTTP
Cancela a goroutine de PDF
PDF n√£o continua ap√≥s cancelamento
Teste automatizado ou simula√ß√£o controlada
Proibido
Graceful shutdown
SIGTERM
Gate atendido
GATE 0.4 ‚Äî Cancelamento

FASE 8.5 ‚Äî CT-04: Graceful Shutdown
Escopo √∫nico
Tratamento de SIGTERM
WorkerPool:
Para de aceitar novas tarefas
Processa buffer pendente
Encerra em at√© 15s
Evid√™ncia expl√≠cita (log, teste ou simula√ß√£o)
Gate atendido
GATE 0.5 ‚Äî Graceful Shutdown

‚úÖ CONCLUS√ÉO DO GATE 0
Ap√≥s 8.1 ‚Üí 8.5 conclu√≠das e evidenciadas:
üîí Produ√ß√£o PERMITIDA (com risco controlado)


---------------------------------------------------------------------------------------------------------------

FASE 9 ‚Äî PRONTID√ÉO OPERACIONAL (GATE 1)

Produ√ß√£o poss√≠vel, mas ainda n√£o ‚Äúenterprise-ready‚Äù.

FASE 9.1 ‚Äî WorkerPool Configur√°vel
Workers via ENV
Buffer via ENV
Nenhum valor hardcoded

FASE 9.2 ‚Äî Integra√ß√£o Real de PDFs
Endpoint ou fluxo produtivo
Context propagado:
HTTP ‚Üí usecase ‚Üí worker

FASE 9.3 ‚Äî CT-02 no Fluxo de Produ√ß√£o (BOM)
Lock pessimista validado em ProduceItem
N√£o apenas estoque isolado

FASE 9.4 ‚Äî Observabilidade M√≠nima
request_id propagado
Logs correlacion√°veis

---------------------------------------------------------------------------------------------------------------

FASE 10 ‚Äî ROBUSTEZ E QUALIDADE (GATE 2)

N√£o bloqueia produ√ß√£o, mas define maturidade de produto.

FASE 10.1 ‚Äî Testes Unit√°rios
Usecases cr√≠ticos:
Stock
BOM
Margin

FASE 10.2 ‚Äî BOM Update Robusto
Add / Remove / Modify expl√≠citos
Sem depend√™ncia impl√≠cita de FullSaveAssociations

FASE 10.3 ‚Äî Produ√ß√£o com Bin Expl√≠cito
BinID nunca impl√≠cito
Mesmo com default configur√°vel

FASE 10.4 ‚Äî Circuit Breaker de E-mail
Retry simples
Backoff b√°sico
Classifica√ß√£o de falha definitiva


---------------------------------------------------------------------------------------------------------------
11.R
Projetar a estrutura t√©cnica e os contratos de interface de um ERP/CRM robusto, seguindo
rigorosamente os padr√µes de Clean Architecture e as restri√ß√µes de infraestrutura moderna.

11.C
Estabelecer um checklist m√≠nimo e verific√°vel para execu√ß√£o segura do sistema em ambientes de produ√ß√£o n√£o 
massivos, cobrindo aspectos operacionais, de infraestrutura e execu√ß√£o real do bin√°rio.
Esta fase N√ÉO introduz c√≥digo, N√ÉO altera arquitetura, N√ÉO cria requisitos funcionais e N√ÉO bloqueia produ√ß√£o.
Seu prop√≥sito √© reduzir risco operacional e formalizar responsabilidades fora do c√≥digo.

11.D
Produzir um Runbook Operacional B√°sico, documentando passo a passo como um operador deve agir diante de 
incidentes comuns j√° conhecidos pelo desenho do sistema.


---------------------------------------------------------------------------------------------------------------


12.1 ‚Äî Vari√°veis de Ambiente Documentadas
Requisitos
Criar documenta√ß√£o clara e versionada contendo:
Nome da vari√°vel
Descri√ß√£o objetiva
Valor esperado (tipo, formato)
Valor default (se existir)
Impacto se ausente
Restri√ß√µes
Nenhuma vari√°vel nova pode ser criada
Apenas documenta√ß√£o do que j√° √© consumido pelo c√≥digo
N√£o alterar leitura de env vars no c√≥digo
Artefato esperado
Documento Markdown (ex: docs/env_vars.md)

12.2 ‚Äî Timeout de Reverse Proxy (PDF / Requests longas)
Requisitos
Documentar valores m√≠nimos recomendados de timeout para:
Gera√ß√£o de PDF
Endpoints potencialmente longos
Exemplos v√°lidos:
Nginx
Traefik
Restri√ß√µes
N√£o criar arquivos de configura√ß√£o reais de proxy
Apenas documenta√ß√£o e recomenda√ß√µes
Sem tuning de performance
Artefato esperado
Se√ß√£o dedicada em docs/production_notes.md ou equivalente

12.3 ‚Äî Estrat√©gia de Backup de Banco de Dados
Requisitos
Definir estrat√©gia m√≠nima de backup:
Tipo (full)
Frequ√™ncia
Reten√ß√£o sugerida
Escopo:
Banco √∫nico
Ambiente √∫nico
Restri√ß√µes
N√£o implementar scripts autom√°ticos
N√£o integrar com cloud providers
N√£o versionar dumps reais
Artefato esperado
Documento explicativo (ex: docs/backup_strategy.md)

12.4 ‚Äî Execu√ß√£o em Ambiente Linux Real
Requisitos
Validar explicitamente que:
O bin√°rio Linux √© execut√°vel
A aplica√ß√£o inicia corretamente
Ambientes v√°lidos:
VM Linux
Container Docker
CI Linux
Restri√ß√µes
N√£o corrigir testes
N√£o alterar comandos de build
Apenas comprova√ß√£o operacional
Evid√™ncia exigida
Registro em SESSION_LOG declarando:
Ambiente utilizado
Resultado (sucesso/falha)

12.5 ‚Äî Log Rotation no Host
Requisitos
Definir pol√≠tica m√≠nima de rota√ß√£o:
Tamanho m√°ximo
Reten√ß√£o
Compress√£o (sim/n√£o)
Exemplos aceit√°veis:
logrotate
journald
Restri√ß√µes
N√£o fornecer arquivos reais de configura√ß√£o
Apenas orienta√ß√£o operacional
Artefato esperado
Documento ou se√ß√£o dedicada em docs/operations.md

---------------------------------------------------------------------------------------------------------------

An√°lise de Complexidade ‚Äî GRUPO 13
Tarefas Propostas

13.1 ‚Äî Auditoria de Depend√™ncias

An√°lise de go.mod
Identifica√ß√£o de CVEs
Atualiza√ß√£o de libs cr√≠ticas
Complexidade: M√âDIA | Risco de Looping: BAIXO


13.2 ‚Äî Rate Limiting

Middleware Echo
Configura√ß√£o via ENV
Testes unit√°rios
Complexidade: M√âDIA | Risco de Looping: M√âDIO (depende de implementa√ß√£o)


13.3 ‚Äî CORS Configur√°vel

Middleware Echo
Valida√ß√£o de origins via ENV
Complexidade: BAIXA | Risco de Looping: BAIXO


13.4 ‚Äî Headers de Seguran√ßa

HSTS, CSP, X-Frame-Options, etc.
Middleware Echo
Complexidade: BAIXA | Risco de Looping: BAIXO


13.5 ‚Äî Valida√ß√£o de Input Refor√ßada

Sanitiza√ß√£o de strings
Valida√ß√£o de UUID
Preven√ß√£o de SQL Injection (GORM j√° protege, mas validar)
Complexidade: ALTA | Risco de Looping: ALTO

---------------------------------------------------------------------------------------------------------------

Fase 14.1: Auditoria de Dom√≠nio (Persistente)

Implementar uma tabela de audit_logs no banco de dados para registrar altera√ß√µes em entidades cr√≠ticas. 
Ao contr√°rio dos logs estruturados (t√©cnicos), estes registros s√£o para consulta de neg√≥cio (ex: "Hist√≥rico de movimenta√ß√µes do Item X"). 

Fase 14.2: Refinamento Fiscal e Tribut√°rio

Evoluir o dom√≠nio de Invoice para incluir bases de c√°lculo de impostos (ICMS/ISS/VAT), permitindo que o Dashboard 
de Margem reflita o lucro l√≠quido real e n√£o apenas o bruto. 


Fase 14.3: Implementa√ß√£o de Background Workers Reais

Converter a gera√ß√£o de PDF (atualmente s√≠ncrona) para o Internal Task Runner ass√≠ncrono, utilizando o 
Worker Pool para evitar que requisi√ß√µes de longa dura√ß√£o travem a API.

FASE 14.4

Objetivo: Consolidar a documenta√ß√£o do Grupo 14 e estabilizar o ambiente de testes de integra√ß√£o para o banco de dados.

Escopo:

Estabiliza√ß√£o de Testes: Corrigir o setup de banco de dados nos testes de integra√ß√£o (test_main ou similar) para permitir que a Fase 15 execute queries reais com SELECT FOR UPDATE.

Documenta√ß√£o: Criar/Atualizar os documentos de Auditoria e Vari√°veis de Ambiente citados acima.

Cleanup: Remover mocks obsoletos que foram substitu√≠dos pela l√≥gica ass√≠ncrona.

---------------------------------------------------------------------------------------------------------------

